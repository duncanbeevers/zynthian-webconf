
<h2>{{ title }}</h2>

<form method="post">
<div class="container-fluid lib-treeview">
	<div class="row">
		<div class="col-md-5">
			<div id="snapshot-new-bank-panel">
				<div class="input-group">
					<span class="input-group-addon">
						<label>New bank</label>
					</span>
					<input  name="NEW_BANK_NUM" aria-label="New Bank" value="{{ config['NEXT_BANK_NUM'] }}" class="form-control">
					<span class="input-group-btn">
						<button id="button-new_bank" name="ACTION" value="NEW_BANK" class="btn btn-theme btn-block" title="Create New Bank"><i class="fa fa-plus"></i></button>
						<span id="loading-action-new_bank" style="display:none;"><img src="/img/loading.gif"></span>
					</span>
				</div>
			</div>

			<div id="snapshot-tree"></div>
		</div>


		<div id="snapshot-panel" class="col-md-7">
			<input type="hidden" id="SEL_FULLPATH" name="SEL_FULLPATH" />
			<div class="row no-gutters">
				<div class="col-xs-5">
					<label>Name:</label>
					<input id="SEL_NAME" name="SEL_NAME" class="form-control" />
				</div>
				<div class="col-xs-3">
					<label>Bank:</label>
					<input type="hidden" id="SEL_BANK_NUM" name="SEL_BANK_NUM" />
					<select id="SEL_BANK" name="SEL_BANK"
						class="form-control">
						{% for option in config['BANKS'] %}
							<option value="{{  option  }}" >{{ option }}</option>
						{% end %}
					</select>
				</div>
				<div class="col-xs-2">
					<label>Program:</label>
					<select id="SEL_PROG_NUM" name="SEL_PROG_NUM"
						class="form-control">
						{% for option in config['PROGS_NUM'] %}
							<option value="{{  option  }}" >{{ option }}</option>
						{% end %}
					</select>
				</div>
				<div class="col-xs-1">
					<label>&nbsp;</label>
					<button name="ACTION" value="SAVE" class="btn btn-theme btn-block"><i class="fa fa-check"></i></button>
				</div>
				<div class="col-xs-1">
					<label>&nbsp;</label>
					<button name="ACTION" value="REMOVE" class="btn btn-danger btn-block" onclick="return confirm('Are you sure to remove this bank and all its snapshots?');"><i class="fa fa-trash-o"></i></button>
				</div>
			</div>

			<div class="row" id="LAYOUTS_TABLE_PANEL">
				<div class="col-md-12">
					<label>Layout</label>
					<table id="LAYOUTS_TABLE"
						   name="LAYOUTS_TABLE"
						   data-toggle="LAYOUTS_TABLE"
						   class="table table-striped table-bordered table-condensed table-hidden-header">
						<thead>
							<tr>
								<th data-field="details">Layout</th>
							</tr>
						</thead>
					</table>
				</div>
			</div>

			<div class="row" id="MIDI_PROFILE_STATE_PANEL">
				<div class="col-md-12">
					<label>Options</label>
					<table id="MIDI_PROFILE_STATE"
						   name="MIDI_PROFILE_STATE"
						   data-toggle="MIDI_PROFILE_STATE"
						   data-show-footer="true"
						   class="table table-striped table-bordered table-condensed table-hidden-header">
						<thead>
							<tr>
								<th data-field="key"
									data-formatter="operateFormatter"
									data-events="midiProfileEvents"
									data-footer-formatter="operateFooterFormatter"
									>&nbsp;</th>
								<th data-field="name"
									data-footer-formatter="selectMidiProfileFormatter"
								>Options</th>
								<th data-field="value">&nbsp;</th>
							</tr>
						</thead>
					</table>
				</div>
			</div>

			
			{% if errors %}
			<div class="row">
				<div class="col-md-12">
					<div class="alert alert-danger">{{ errors }}</div>
				</div>
			</div>
			{% end %}

			<div class="row">
				<div class="col-md-12">
					<button id="ACTION_SAVE_AS_DEFAULT" name="ACTION" value="SAVE_AS_DEFAULT" class="btn btn-theme btn-block">Save as Default</button>
				</div>
			</div>
			<div class="row">
				<div class="col-md-12">
					<button id="ACTION_SAVE_AS_LAST_STATE" name="ACTION" value="SAVE_AS_LAST_STATE" class="btn btn-theme btn-block">Save as Last State</button>
				</div>
			</div>

		</div>
	</div>
</div>
</form>

<script type="text/javascript">

$('#snapshot-panel').hide();
$('#zynthian-selection-customized-panel').hide();

window.midiProfileEvents = {
	'click .remove-option': function (e, value, row, index) {
		if (confirm('Do you really want to delete the option ' + value + '?')){
			$.post("lib-snapshot/remove/" + $("#SEL_FULLPATH")[0].value + "/" + value,
				null,
				function(data, status) {
					if (status=="success") {
						if (data){
							if ("errors" in data) {
								console.log("RemoveSnapshotOption Error: " + data["errors"])
							} else {
								optionsData = getMidiProfileStateData(data);
								$("#MIDI_PROFILE_STATE").bootstrapTable('load', optionsData);
							}
						}
					} else {
						console.log("RemoveSnapshotOption Response: " + status)

					}
				}
			);
		}

	}
}

$("#LAYOUTS_TABLE").bootstrapTable({
	data: []
});
$("#MIDI_PROFILE_STATE").bootstrapTable({
	data: []
});
$('#snapshot-tree').treeview({data: JSON.parse('{% raw config['SNAPSHOTS'].replace("'", "&#39;") %}'), bootstrap2: true ,
	emptyIcon: "glyphicon glyphicon-floppy-disk",
	expandIcon: "glyphicon glyphicon-folder-close",
	collapseIcon: "glyphicon glyphicon-folder-open",
	onNodeSelected: function(event, data) {
		$("#SEL_NAME")[0].value = data.name.replace("&#39;","'");
		$("#SEL_FULLPATH")[0].value = data.fullpath;
		$("#SEL_BANK_NUM")[0].value = data.bank_num;
		$("#SEL_BANK")[0].value = data.bank_num + (data.bank_name? '-' + data.bank_name.replace("&#39;","'") : '');
		$("#SEL_BANK")[0].disabled = data.nodes;
		$("#SEL_PROG_NUM")[0].value = data.prog_num;
		$("#SEL_PROG_NUM")[0].disabled = data.nodes;
		if (data.prog_details){
			layoutsData = getLayoutData(data.prog_details);
			$("#LAYOUTS_TABLE").bootstrapTable('load', layoutsData);
			$("#LAYOUTS_TABLE_PANEL").show();

			optionsData = getMidiProfileStateData(data.prog_details);
			$("#MIDI_PROFILE_STATE").bootstrapTable('load', optionsData);
			$("#MIDI_PROFILE_STATE_PANEL").show();

			$("#ACTION_SAVE_AS_DEFAULT").show();
			$("#ACTION_SAVE_AS_LAST_STATE").show();
		} else {
			$("#MIDI_PROFILE_STATE_PANEL").hide();
			$("#LAYOUTS_TABLE_PANEL").hide();
			$("#ACTION_SAVE_AS_DEFAULT").hide();
			$("#ACTION_SAVE_AS_LAST_STATE").hide();
		}
		$('#snapshot-panel').show();
	}
});
$('#snapshot-tree').treeview('selectNode',{% raw config['SEL_NODE_ID'] %});

function addMidiOptions() {
	$.post("lib-snapshot/add/" + btoa($("#SEL_FULLPATH")[0].value) + "/" + btoa($("#SELECTED_MIDI_PROFILE_SCRIPT").val())  ,
			null,
			function(data, status) {
				if (status=="success") {
					if (data){
						if ("errors" in data) {
							console.log("AddSnapshotOptions Error: " + data["errors"])
						} else {
							optionsData = getMidiProfileStateData(data);
							$("#MIDI_PROFILE_STATE").bootstrapTable('load', optionsData);
						}
					}
				} else {
					console.log("AddSnapshotOptions Response: " + status)
				}
			}
		);
}
/*
function formatSnapshotDetails(snapshotDetails){
	var result = "";
	for (var ch=0; ch<16; ch++) {
		ch_layout = "";
		for (idx in snapshotDetails.layers) {
			layer = snapshotDetails.layers[idx]
			if (ch==layer.midi_chan) {
				if (ch_layout!="") ch_layout += "  ->";
				else  ch_layout += (layer.midi_chan + 1) + '#';
				ch_layout += layer.engine_nick + ">"
				if (layer.bank_name) ch_layout += layer.bank_name + "/";
				if (layer.preset_name) ch_layout += layer.preset_name;
				ch_layout += "\n";
			}
		}
		result += ch_layout;
	}
	return result;
}
*/
function getMidiProfileStateData(snapshotDetails){
	result = [];
	for (midiKey in snapshotDetails.midi_profile_state){
		result.push({'key': midiKey, 'name': midiKey, 'value': snapshotDetails.midi_profile_state[midiKey]});
	}
	return result;
}

function getLayoutData(snapshotDetails){
	result = [];
	for (layerKey in snapshotDetails.layers){
		layer = snapshotDetails.layers[layerKey];
		if (layer.midi_chan != null) {
			details = "";
			details += (layer.midi_chan + 1) + '#';
			details += layer.engine_nick + ">"
			if (layer.bank_name) details += layer.bank_name + "/";
			if (layer.preset_name) details += layer.preset_name;
			result.push({'channel': layer.midi_chan + 1,
					'engine_nick': layer.engine_nick,
					'bank_name': layer.bank_name,
					'preset_name': layer.preset_name,
					'details': details });
		}
	}

	if (result.len > 0){
		result.sort(compare_layer);
	}
	return result;
}

function compare_layer( a, b ) {
  if ( a.channel < b.channel ){
    return -1;
  }
  if ( a.channel > b.channel ){
    return 1;
  }
  if ( a.details < b.details ){
  	return -1;
  }
  if ( a.details > b.details ){
  	return 1;
  }
  return 0;
}

function operateFormatter(value, row, index) {
    return [
      '<a class="remove-option" href="javascript:void(0)" title="Remove">',
      '<i class="fa fa-trash"></i>',
      '</a>'
    ].join('')
}

function operateFooterFormatter(items) {
    return [
      '<a class="add-options" href="javascript:addMidiOptions()" title="Add">',
      '<i class="fa fa-plus"></i>',
      '</a>'
    ].join('')
}

function selectMidiProfileFormatter(items) {
	result = [];
	result.push('<select id="SELECTED_MIDI_PROFILE_SCRIPT">');
{% for midi_profile_script in config['MIDI_PROFILE_SCRIPTS'] %}
	result.push('<option value="{{ config['MIDI_PROFILE_SCRIPTS'][midi_profile_script] }}">{{ midi_profile_script }}</option>');
{% end %}

	result.push('</select>');

	return result;
}

</script>